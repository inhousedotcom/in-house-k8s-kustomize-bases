#!/bin/bash
# Pre-commit hook to check CHANGELOG.md is updated
# Only enforced when committing to main branch
# For feature branches, this is just a reminder

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get current branch
BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || echo "detached")

echo "üîç Checking CHANGELOG.md..."

# Check if CHANGELOG.md exists
if [ ! -f "CHANGELOG.md" ]; then
    echo -e "${RED}‚ùå CHANGELOG.md not found!${NC}"
    exit 1
fi

# Only enforce on main branch, warn on others
if [ "$BRANCH" != "main" ]; then
    echo -e "${BLUE}‚ÑπÔ∏è  On branch: $BRANCH${NC}"
    echo -e "${BLUE}   CHANGELOG check is advisory only on feature branches${NC}"
    
    # Check if any non-documentation files changed
    if git diff --cached --name-only | grep -qvE '^(README|CHANGELOG|\.md$|docs/)'; then
        if ! git diff --cached --name-only | grep -q "CHANGELOG.md"; then
            echo -e "${YELLOW}‚ö†Ô∏è  Reminder: Update CHANGELOG.md before creating PR to main${NC}"
        fi
    fi
    
    # Always allow commits on feature branches
    exit 0
fi

# STRICT checks for main branch
echo -e "${YELLOW}‚ö†Ô∏è  Committing to main branch - strict CHANGELOG checks enabled${NC}"

# Check if CHANGELOG.md is staged (being committed)
if ! git diff --cached --name-only | grep -q "CHANGELOG.md"; then
    echo -e "${RED}‚ùå CHANGELOG.md must be updated when committing to main${NC}"
    echo ""
    echo "Please update CHANGELOG.md with:"
    echo ""
    echo "## [vX.Y.Z] - Unreleased"
    echo ""
    echo "### Added/Changed/Fixed"
    echo "- Your changes here"
    echo ""
    echo -e "${YELLOW}To bypass this check: git commit --no-verify${NC}"
    exit 1
fi

# Check for unreleased version in CHANGELOG
if ! grep -q "\[v[0-9]*\.[0-9]*\.[0-9]*\] - Unreleased" CHANGELOG.md; then
    echo -e "${RED}‚ùå No unreleased version found in CHANGELOG.md${NC}"
    echo ""
    echo "Expected format:"
    echo "## [v1.2.3] - Unreleased"
    echo ""
    echo "### Added"
    echo "- Feature description"
    exit 1
fi

# Extract version
VERSION=$(grep -m 1 "\[v.*\] - Unreleased" CHANGELOG.md | sed 's/.*\[\(v[0-9.]*\)\].*/\1/')

# Validate version format
if ! [[ "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo -e "${RED}‚ùå Invalid version format: $VERSION${NC}"
    echo "Expected: v1.2.3 (semantic versioning)"
    exit 1
fi

# Check if version already exists as a tag
if git rev-parse "$VERSION" >/dev/null 2>&1; then
    echo -e "${RED}‚ùå Version $VERSION already exists as a git tag${NC}"
    echo "Please increment the version number in CHANGELOG.md"
    exit 1
fi

# Check if version is already released in CHANGELOG
if grep -q "\[$VERSION\] - [0-9]" CHANGELOG.md; then
    echo -e "${RED}‚ùå Version $VERSION is already marked as released${NC}"
    echo "Please use a new version number"
    exit 1
fi

echo -e "${GREEN}‚úÖ CHANGELOG.md validated successfully${NC}"
echo -e "${GREEN}   Version: $VERSION${NC}"
echo ""

exit 0
